name: Deploy CHLA Provider Map

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-west-2
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('maplocation/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Cache Node dependencies
      uses: actions/cache@v4
      with:
        path: map-frontend/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('map-frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install backend dependencies
      run: |
        cd maplocation
        pip install -r requirements.txt
    
    - name: Install frontend dependencies
      run: |
        cd map-frontend
        npm ci
    
    - name: Run backend tests
      run: |
        cd maplocation
        python manage.py check
        # Add more tests when available
        # python manage.py test
    
    - name: Lint frontend
      run: |
        cd map-frontend
        npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: map-frontend/dist/
        retention-days: 1

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install EB CLI
      run: |
        pip install awsebcli
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Create deployment package
      run: |
        cd maplocation
        zip -r ../deployment-package.zip . -x "*.git*" "*.venv*" "*.DS_Store*" "*.pyc*" "__pycache__/*"
    
    - name: Deploy to Elastic Beanstalk via AWS CLI
      run: |
        # Generate unique timestamp
        TIMESTAMP=$(date +%s)
        
        # Upload to S3 first
        aws s3 cp deployment-package.zip s3://elasticbeanstalk-us-west-2-795519544722/chla-api/deployment-package-${TIMESTAMP}.zip
        
        # Create application version
        VERSION_LABEL="deploy-${TIMESTAMP}"
        aws elasticbeanstalk create-application-version \
          --application-name chla-api \
          --version-label "$VERSION_LABEL" \
          --source-bundle S3Bucket="elasticbeanstalk-us-west-2-795519544722",S3Key="chla-api/deployment-package-${TIMESTAMP}.zip" \
          --auto-create-application || echo "Application already exists"
        
        # Deploy to environment
        aws elasticbeanstalk update-environment \
          --environment-name chla-api-prod \
          --version-label "$VERSION_LABEL" || echo "Deployment in progress"
    
    - name: Wait for deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 60
    
    - name: Set environment variables after deployment
      run: |
        # Set environment variables via AWS CLI
        aws elasticbeanstalk update-environment \
          --environment-name chla-api-prod \
          --option-settings \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=DJANGO_SECRET_KEY,Value="${{ secrets.DJANGO_SECRET_KEY }}"' \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=DJANGO_DEBUG,Value=false' \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=ALLOWED_HOSTS,Value="api.kinddhelp.com,.elasticbeanstalk.com,localhost"' \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=CORS_ALLOWED_ORIGINS,Value="https://kinddhelp.com,https://www.kinddhelp.com"' \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=CSRF_TRUSTED_ORIGINS,Value="https://api.kinddhelp.com,https://kinddhelp.com,https://www.kinddhelp.com"' \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=DB_NAME,Value=postgres' \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=DB_USER,Value=chla_admin' \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=DB_PASSWORD,Value="${{ secrets.DB_PASSWORD }}"' \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=DB_HOST,Value="${{ secrets.DB_HOST }}"' \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=DB_PORT,Value=5432' \
          'Namespace=aws:elasticbeanstalk:application:environment,OptionName=DB_SSL_REQUIRE,Value=true' || echo "Environment variables will be set via .ebextensions"
    
    - name: Verify deployment
      run: |
        echo "Checking backend health..."
        sleep 30  # Wait for deployment to settle
        # Try multiple times in case the deployment is still warming up
        for i in {1..3}; do
          if curl -f -m 10 https://api.kinddhelp.com/api/regional-centers/; then
            echo "Backend is healthy!"
            break
          else
            echo "Attempt $i failed, waiting 20 seconds..."
            sleep 20
          fi
        done

  deploy-frontend:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Cache Node dependencies
      uses: actions/cache@v4
      with:
        path: map-frontend/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('map-frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: |
        cd map-frontend
        npm ci
    
    - name: Build frontend
      run: |
        cd map-frontend
        echo "VITE_API_BASE_URL=https://api.kinddhelp.com" > .env
        echo "VITE_MAPBOX_TOKEN=pk.eyJ1IjoiYWxleGJlYXR0aWUiLCJhIjoiOVVEYU52WSJ9.S_uekMjvfZC5_s0dVVJgQg" >> .env
        npm run build
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Deploy to S3
      run: |
        cd map-frontend
        aws s3 sync dist s3://kinddhelp-frontend-1755148345 --delete
    
    - name: Invalidate CloudFront cache
      run: |
        aws cloudfront create-invalidation \
          --distribution-id E2W6EECHUV4LMM \
          --paths "/*"
    
    - name: Verify deployment
      run: |
        echo "Waiting for CloudFront invalidation to propagate..."
        sleep 60
        echo "Checking frontend..."
        curl -f https://kinddhelp.com/ || echo "Frontend check failed but continuing"

  notify:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Deployment Status
      run: |
        if [[ "${{ needs.deploy-backend.result }}" == "success" && "${{ needs.deploy-frontend.result }}" == "success" ]]; then
          echo "‚úÖ Deployment successful!"
          echo "Backend: https://api.kinddhelp.com"
          echo "Frontend: https://kinddhelp.com"
        else
          echo "‚ùå Deployment failed!"
          echo "Backend status: ${{ needs.deploy-backend.result }}"
          echo "Frontend status: ${{ needs.deploy-frontend.result }}"
          exit 1
        fi
    
    # Option 1: GitHub Issue Comment (works immediately, no setup needed)
    - name: Create deployment comment
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const deploymentStatus = '${{ needs.deploy-backend.result }}' === 'success' && '${{ needs.deploy-frontend.result }}' === 'success';
          const emoji = deploymentStatus ? '‚úÖ' : '‚ùå';
          const status = deploymentStatus ? 'successful' : 'failed';
          const time = new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });
          
          const body = `${emoji} **Deployment ${status}!**
          
          - **Time**: ${time}
          - **Backend**: ${{ needs.deploy-backend.result }} - https://api.kinddhelp.com
          - **Frontend**: ${{ needs.deploy-frontend.result }} - https://kinddhelp.com
          - **Commit**: ${{ github.sha }}
          - **Triggered by**: ${{ github.actor }}
          
          ${deploymentStatus ? 'üéâ Your changes are now live!' : '‚ö†Ô∏è Please check the logs for errors.'}`;
          
          // Find or create a deployment issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['deployment-status'],
            state: 'open'
          });
          
          if (issues.data.length > 0) {
            // Comment on existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: body
            });
          }
    
    # Option 2: Email notification (requires EMAIL secret)
    - name: Send email notification
      if: always() && secrets.EMAIL != ''
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: ${{ needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success' && '‚úÖ CHLA Deployment Successful' || '‚ùå CHLA Deployment Failed' }}
        to: ${{ secrets.EMAIL }}
        from: GitHub Actions
        body: |
          Deployment Status: ${{ needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success' && 'SUCCESS' || 'FAILED' }}
          
          Backend: ${{ needs.deploy-backend.result }} - https://api.kinddhelp.com
          Frontend: ${{ needs.deploy-frontend.result }} - https://kinddhelp.com
          
          Commit: ${{ github.sha }}
          Triggered by: ${{ github.actor }}
          Time: ${{ github.event.head_commit.timestamp }}
          
          View deployment: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    # Option 3: Slack notification (requires SLACK_WEBHOOK secret)
    - name: Slack Notification
      if: always() && secrets.SLACK_WEBHOOK != ''
      uses: 8398a7/action-slack@v3
      with:
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        status: ${{ job.status }}
        text: |
          ${{ needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success' && '‚úÖ CHLA Deployment Successful!' || '‚ùå CHLA Deployment Failed!' }}
          Backend: ${{ needs.deploy-backend.result }}
          Frontend: ${{ needs.deploy-frontend.result }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
