commands:
  01_install_epel:
    command: |
      set -x
      echo "===  Installing EPEL repository ==="
      dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm 2>&1 | tee /tmp/epel-install.log
      echo "EPEL installation exit code: $?"
    ignoreErrors: false

  02_install_gdal:
    command: |
      set -x
      echo "=== Installing GDAL and dependencies ==="
      dnf install -y gdal gdal-libs gdal-devel geos geos-devel proj proj-devel 2>&1 | tee /tmp/gdal-install.log
      EXIT_CODE=$?
      echo "GDAL installation exit code: $EXIT_CODE"
      ldconfig
      ldconfig -p | grep -i "libgdal\|libgeos" | tee /tmp/gdal-verify.log
      if [ $EXIT_CODE -ne 0 ]; then
        echo "ERROR: GDAL installation failed"
        exit 1
      fi
    ignoreErrors: false

  03_verify_gdal:
    command: |
      set -x
      echo "=== GDAL Installation Verification ==="
      which gdalinfo && gdalinfo --version || echo "ERROR: gdalinfo command not found or not working"
      echo "=== Library check ==="
      ldconfig -p | grep -i "libgdal" || echo "ERROR: libgdal not found in ldconfig"
      ldconfig -p | grep -i "libgeos" || echo "ERROR: libgeos not found in ldconfig"
      echo "=== File system check ==="
      find /usr/lib* -name "libgdal.so*" 2>/dev/null | head -5 || echo "ERROR: No libgdal.so files found"
      find /usr/lib* -name "libgeos.so*" 2>/dev/null | head -5 || echo "ERROR: No libgeos.so files found"
    ignoreErrors: true

  02_enable_postgis:
    command: |
      # Enable PostGIS extension on RDS (requires superuser, may fail gracefully)
      # This should be run manually via psql or RDS console if it fails
      echo "PostGIS extension should be enabled manually on RDS if not already done"
      echo "Run: CREATE EXTENSION IF NOT EXISTS postgis; as RDS superuser"
    ignoreErrors: true
